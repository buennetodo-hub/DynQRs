<script>
    const AS_URL_BASE = "https://script.google.com/macros/s/AKfycbwQtDWavPfbnw1PDAPLhMSVxtgPwyIYlA2KvE4aHcfz5N30YOgheou1BPm-UHBrBuF5eQ/exec";
    
    // Función para obtener/generar un UUID de usuario
    function getUserId() {
        let userId = localStorage.getItem('qr_user_id'); // 1. Intentar obtener el ID guardado
        if (!userId) {
            // 2. Si no existe, generar un nuevo UUID
            // Usamos una función simple en caso de que crypto.randomUUID no esté disponible
            userId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
            localStorage.setItem('qr_user_id', userId); // 3. Guardar el nuevo ID
        }
        return userId;
    }

    var url = document.location.href;
    var k = url.substr(url.lastIndexOf("k=")+2);
    
    if(k) {
        // Obtener el ID de usuario
        const userId = getUserId(); 
        
        // 4. Añadir el user_id a la URL de la solicitud a Apps Script
        fetch(AS_URL_BASE + '?k=' + k + '&user_id=' + userId) 
            .then(r => r.text())
            .then((r) => {
                console.log(r);
                if(r){
                    document.location.replace(r);
                }
            })
            .catch(err => console.log(err))
    }
</script>
